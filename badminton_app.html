<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³ ãƒ€ãƒ–ãƒ«ã‚¹çµ„ã¿åˆã‚ã›ãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --border: #ddd;
            --busy: #e74c3c;
            --waiting: #3498db;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: #333;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 2px;
        }

        input, select {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 1rem;
        }

        input[type="number"] { width: 60px; }
        input[type="time"] { width: 100px; }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            font-size: 0.95rem;
        }

        .btn-add { background-color: var(--accent); color: white; margin-top: auto; }
        .btn-add:hover { background-color: #219150; }

        /* ã‚³ãƒ¼ãƒˆç®¡ç†ã‚¨ãƒªã‚¢ */
        .court-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
        }

        .btn-auto-fill { background-color: #3498db; color: white; }
        .btn-auto-fill:hover { background-color: #2980b9; }

        .btn-manual-match { background-color: #9b59b6; color: white; }
        .btn-manual-match:hover { background-color: #8e44ad; }
        .btn-manual-match:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        .btn-danger { background-color: #e74c3c; color: white; padding: 5px 10px; font-size: 0.8rem; }
        .btn-reset { background-color: #95a5a6; color: white; margin-top: 20px; }

        /* ãƒãƒƒãƒãƒ³ã‚°ã‚¨ãƒªã‚¢ */
        #match-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .court-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            border-top: 5px solid #bdc3c7; /* Default empty */
            display: flex;
            flex-direction: column;
            min-height: 200px;
        }

        .court-card.active { border-top-color: var(--busy); }
        .court-card.empty { border-top-color: var(--accent); }

        .court-header {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .court-status { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; color: white; }
        .status-active { background-color: var(--busy); }
        .status-empty { background-color: var(--accent); }

        .empty-placeholder {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #aaa;
            flex-direction: column;
            gap: 10px;
        }

        .match-vs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            flex: 1;
        }

        .team { flex: 1; text-align: center; }
        .team-player { display: block; margin: 4px 0; font-weight: 500; }
        .player-info { font-size: 0.8rem; color: #7f8c8d; }
        .vs-badge { font-weight: bold; color: #999; margin: 0 10px; }

        .btn-finish { width: 100%; background-color: #f39c12; color: white; margin-top: auto; }
        .btn-court-action { background-color: #3498db; color: white; padding: 5px 15px; font-size: 0.9rem; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ */
        .list-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #666; font-size: 0.9rem; }
        tr:hover { background-color: #f1f1f1; }

        .game-count-badge {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.9rem;
            min-width: 30px;
            text-align: center;
            display: inline-block;
        }

        .status-dot {
            height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px;
        }
        .dot-playing { background-color: var(--busy); }
        .dot-waiting { background-color: var(--accent); }

        .btn-sm {
            padding: 2px 8px;
            font-size: 0.9rem;
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            margin: 0 2px;
            cursor: pointer;
        }
        .btn-sm:hover { background-color: #bdc3c7; }

        /* é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .p-select { transform: scale(1.3); cursor: pointer; }

        @media (max-width: 600px) {
            .input-panel { flex-direction: column; align-items: stretch; }
            .btn-add { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¸ ãƒ€ãƒ–ãƒ«ã‚¹çµ„ã¿åˆã‚ã›ã‚¢ãƒ—ãƒª</h1>

    <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="input-panel">
        <div class="input-group">
            <label>åå‰</label>
            <input type="text" id="pName" placeholder="ä¾‹: ä½è—¤" required>
        </div>
        <div class="input-group">
            <label>æ€§åˆ¥</label>
            <select id="pGender">
                <option value="ç”·æ€§">ç”·æ€§</option>
                <option value="å¥³æ€§">å¥³æ€§</option>
            </select>
        </div>
        <div class="input-group">
            <label>ãƒ¬ãƒ™ãƒ« (1-10)</label>
            <input type="number" id="pLevel" min="1" max="10" value="5">
        </div>
        <div class="input-group">
            <label>å‚åŠ æ™‚é–“</label>
            <input type="time" id="pTime">
        </div>
        <button class="btn-add" onclick="addPlayer()">è¿½åŠ </button>
    </div>

    <!-- ã‚³ãƒ¼ãƒˆè¨­å®š & æ“ä½œ -->
    <div class="court-controls">
        <div class="input-group" style="flex-direction: row; align-items: center; gap: 5px;">
            <label>ã‚³ãƒ¼ãƒˆæ•°:</label>
            <select id="courtCount" onchange="initCourts()" style="width: auto;">
                <option value="1">1é¢</option>
                <option value="2">2é¢</option>
                <option value="3">3é¢</option>
                <option value="4">4é¢</option>
                <option value="5">5é¢</option>
                <option value="6">6é¢</option>
            </select>
        </div>
        <button class="btn-auto-fill" onclick="fillAllEmptyCourts()">ç©ºãã‚³ãƒ¼ãƒˆã‚’è‡ªå‹•ã§åŸ‹ã‚ã‚‹</button>
    </div>

    <!-- è©¦åˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="match-area"></div>

    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ -->
    <div class="list-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
            <h3>å‚åŠ è€…ãƒªã‚¹ãƒˆ (<span id="playerCount">0</span>å)</h3>
            
            <div style="display: flex; gap: 10px;">
                <button id="manualMatchBtn" class="btn-manual-match" onclick="createManualMatch()" disabled>é¸æŠã—ãŸ4äººã§è©¦åˆä½œæˆ</button>
                <button class="btn-reset" onclick="resetAllData()" style="margin:0; padding: 5px 10px; font-size: 0.8rem;">å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th style="width: 40px; text-align: center;">é¸æŠ</th>
                    <th>åå‰</th>
                    <th>æ€§åˆ¥</th>
                    <th>Lv</th>
                    <th>çŠ¶æ…‹</th>
                    <th>ã‚²ãƒ¼ãƒ æ•°</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="playerListBody">
                <!-- JSã§æç”» -->
            </tbody>
        </table>
    </div>
</div>

<script>
    let players = [];
    let activeMatches = {}; // { 1: { teamA: [], teamB: [] }, ... }

    // åˆæœŸåŒ–å‡¦ç†
    window.onload = function() {
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('pTime').value = timeStr;

        loadData();
        initCourts(false); // UIåˆæœŸæç”»ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å«ã‚€ï¼‰
    };

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
    function addPlayer() {
        const name = document.getElementById('pName').value.trim();
        const gender = document.getElementById('pGender').value;
        const level = parseInt(document.getElementById('pLevel').value);
        const time = document.getElementById('pTime').value;

        if (!name) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        // é…ã‚Œã¦å‚åŠ ï¼šç¾åœ¨ã®æœ€å¤§ã‚²ãƒ¼ãƒ æ•°ã«åˆã‚ã›ã‚‹
        let initialGameCount = 0;
        if (players.length > 0) {
            initialGameCount = Math.max(...players.map(p => p.gameCount));
        }

        const newPlayer = {
            id: Date.now(),
            name: name,
            gender: gender,
            level: level,
            joinedAt: time,
            gameCount: initialGameCount,
            lastPlayedAt: 0 // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆé€£ç¶šåˆ¤å®šç”¨ï¼‰
        };

        players.push(newPlayer);
        saveData();
        updateTable();
        
        // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢ & æ™‚é–“ã‚’ç¾åœ¨æ™‚åˆ»ã«æ›´æ–°
        document.getElementById('pName').value = '';
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('pTime').value = timeStr;

        document.getElementById('pName').focus();
    }

    function removePlayer(id) {
        if(confirm('ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            // è©¦åˆä¸­ã‹ãƒã‚§ãƒƒã‚¯
            if (isPlayerOnCourt(id)) {
                alert("ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç¾åœ¨è©¦åˆä¸­ã§ã™ã€‚å…ˆã«è©¦åˆã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            players = players.filter(p => p.id !== id);
            saveData();
            updateTable();
        }
    }

    // ã‚³ãƒ¼ãƒˆåˆæœŸåŒ–ãƒ»å†æç”»
    function initCourts(resetMatches = true) {
        const courtCount = parseInt(document.getElementById('courtCount').value);
        const matchArea = document.getElementById('match-area');
        
        // ã‚³ãƒ¼ãƒˆæ•°å¤‰æ›´æ™‚ã«æ—¢å­˜ãƒãƒƒãƒã‚’ç¶­æŒã™ã‚‹ã‹ã‚¯ãƒªã‚¢ã™ã‚‹ã‹
        if (resetMatches) {
            // ã“ã“ã§ã¯åŸºæœ¬çš„ã«ã‚¯ãƒªã‚¢ã›ãšã€UIã‚’å†æ§‹ç¯‰ã™ã‚‹ã ã‘ã«ã™ã‚‹
            // ãŸã ã—ã€ã‚³ãƒ¼ãƒˆæ•°ãŒæ¸›ã£ãŸå ´åˆã¯ã€ã¯ã¿å‡ºãŸã‚³ãƒ¼ãƒˆã®è©¦åˆã¯ã©ã†ã™ã‚‹ã‹ï¼Ÿ
            // ä»Šå›ã¯å˜ç´”ã«ç¶­æŒã™ã‚‹ãŒã€éè¡¨ç¤ºã«ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã¯æ®‹ã‚‹ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
        }

        renderCourts();
        updateTable();
    }

    function renderCourts() {
        const courtCount = parseInt(document.getElementById('courtCount').value);
        const matchArea = document.getElementById('match-area');
        matchArea.innerHTML = '';

        for (let i = 1; i <= courtCount; i++) {
            const matchData = activeMatches[i];
            const div = document.createElement('div');
            
            if (matchData) {
                // è©¦åˆä¸­
                div.className = 'court-card active';
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã®ãƒªã‚¹ãƒˆ
                const pIds = [...matchData.teamA, ...matchData.teamB].map(p => p.id);
                const pIdsStr = JSON.stringify(pIds);

                div.innerHTML = `
                    <div class="court-header">
                        <span>ã‚³ãƒ¼ãƒˆ ${i}</span>
                        <span class="court-status status-active">è©¦åˆä¸­</span>
                    </div>
                    <div class="match-vs">
                        <div class="team">
                            <span class="team-player">${matchData.teamA[0].name} <span class="player-info">(Lv${matchData.teamA[0].level})</span></span>
                            <span class="team-player">${matchData.teamA[1].name} <span class="player-info">(Lv${matchData.teamA[1].level})</span></span>
                        </div>
                        <div class="vs-badge">VS</div>
                        <div class="team">
                            <span class="team-player">${matchData.teamB[0].name} <span class="player-info">(Lv${matchData.teamB[0].level})</span></span>
                            <span class="team-player">${matchData.teamB[1].name} <span class="player-info">(Lv${matchData.teamB[1].level})</span></span>
                        </div>
                    </div>
                    <button class="btn-finish" onclick='finishGame(${i}, ${pIdsStr})'>è©¦åˆçµ‚äº† (ã‚«ã‚¦ãƒ³ãƒˆ+1)</button>
                `;
            } else {
                // ç©ºã
                div.className = 'court-card empty';
                div.innerHTML = `
                    <div class="court-header">
                        <span>ã‚³ãƒ¼ãƒˆ ${i}</span>
                        <span class="court-status status-empty">ç©ºã</span>
                    </div>
                    <div class="empty-placeholder">
                        <p>å¾…æ©Ÿä¸­</p>
                        <button class="btn-court-action" onclick="fillSpecificCourt(${i})">ã“ã®ã‚³ãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆ</button>
                    </div>
                `;
            }
            matchArea.appendChild(div);
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚³ãƒ¼ãƒˆæ•°ã‚’ä¿å­˜ã—ãŸã„å ´åˆã¯ã“ã“ã§
        localStorage.setItem('badmintonCourtCount', courtCount);
    }

    // å…¨ã¦ã®ç©ºãã‚³ãƒ¼ãƒˆã‚’åŸ‹ã‚ã‚‹
    function fillAllEmptyCourts() {
        const courtCount = parseInt(document.getElementById('courtCount').value);
        for (let i = 1; i <= courtCount; i++) {
            if (!activeMatches[i]) {
                fillSpecificCourt(i);
            }
        }
    }

    // ç‰¹å®šã®ã‚³ãƒ¼ãƒˆã«è‡ªå‹•å‰²ã‚Šå½“ã¦
    function fillSpecificCourt(courtId) {
        // ç¾åœ¨è©¦åˆä¸­ã§ãªã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŠ½å‡º
        const candidates = players.filter(p => !isPlayerOnCourt(p.id));

        if (candidates.length < 4) {
            // è‡ªå‹•ä¸€æ‹¬å®Ÿè¡Œæ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã•ãªã„ï¼ˆã†ã‚‹ã•ã„ã®ã§ï¼‰ã€å€‹åˆ¥å®Ÿè¡Œæ™‚ã¯å‡ºã™
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã ã‘æ®‹ã™
            console.log("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸è¶³");
            return;
        }

        // --- å„ªå…ˆé †ä½ã‚½ãƒ¼ãƒˆ ---
        // 1. ã‚²ãƒ¼ãƒ æ•°ãŒå°‘ãªã„
        // 2. æœ€å¾Œã«è©¦åˆã‚’ã—ã¦ã‹ã‚‰ã®æ™‚é–“ãŒé•·ã„ï¼ˆlastPlayedAtãŒå°ã•ã„ï¼‰
        // 3. å‚åŠ æ™‚é–“ãŒæ—©ã„
        candidates.sort((a, b) => {
            if (Math.abs(a.gameCount - b.gameCount) > 0.1) {
                return a.gameCount - b.gameCount;
            }
            if (a.lastPlayedAt !== b.lastPlayedAt) {
                return a.lastPlayedAt - b.lastPlayedAt;
            }
            return a.joinedAt.localeCompare(b.joinedAt);
        });

        // ä¸Šä½4åã‚’é¸å‡º
        const selected = candidates.slice(0, 4);
        createMatchOnCourt(courtId, selected);
    }

    // æ‰‹å‹•é¸æŠã§è©¦åˆä½œæˆ
    function createManualMatch() {
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‹ã‚‰é¸æŠã•ã‚ŒãŸIDã‚’å–å¾—
        const checkboxes = document.querySelectorAll('.p-select:checked');
        if (checkboxes.length !== 4) {
            alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’4åé¸æŠã—ã¦ãã ã•ã„ã€‚ç¾åœ¨: " + checkboxes.length + "å");
            return;
        }

        const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        const selectedPlayers = players.filter(p => selectedIds.includes(p.id));

        // ç©ºã„ã¦ã„ã‚‹ä¸€ç•ªè‹¥ã„ç•ªå·ã®ã‚³ãƒ¼ãƒˆã‚’æ¢ã™
        const courtCount = parseInt(document.getElementById('courtCount').value);
        let targetCourt = -1;
        for (let i = 1; i <= courtCount; i++) {
            if (!activeMatches[i]) {
                targetCourt = i;
                break;
            }
        }

        if (targetCourt === -1) {
            alert("ç©ºã„ã¦ã„ã‚‹ã‚³ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è©¦åˆã‚’çµ‚äº†ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        createMatchOnCourt(targetCourt, selectedPlayers);
        
        // ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
        checkboxes.forEach(cb => cb.checked = false);
        handleCheckboxChange(); // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
    }

    // 4äººã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å—ã‘å–ã‚Šã€ãƒšã‚¢ãƒªãƒ³ã‚°ã—ã¦ã‚³ãƒ¼ãƒˆã«ã‚»ãƒƒãƒˆã™ã‚‹å…±é€šé–¢æ•°
    function createMatchOnCourt(courtId, members) {
        // ãƒ¬ãƒ™ãƒ«é †ã«ã‚½ãƒ¼ãƒˆ (é™é †: å¼·ã„é †)
        members.sort((a, b) => b.level - a.level);

        // ãƒšã‚¢ä½œæˆ: ãƒãƒ©ãƒ³ã‚¹å‹ (1ä½ & 4ä½) vs (2ä½ & 3ä½)
        const teamA = [members[0], members[3]];
        const teamB = [members[1], members[2]];

        // è©¦åˆãƒ‡ãƒ¼ã‚¿ç™»éŒ²
        activeMatches[courtId] = {
            teamA: teamA,
            teamB: teamB,
            startTime: Date.now()
        };

        saveData();
        renderCourts();
        updateTable();
    }

    // è©¦åˆçµ‚äº†å‡¦ç†
    function finishGame(courtId, playerIds) {
        const now = Date.now();
        // å¯¾è±¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚²ãƒ¼ãƒ æ•°ã‚’+1 ã—ã€æœ€çµ‚ãƒ—ãƒ¬ã‚¤æ™‚åˆ»ã‚’æ›´æ–°
        players.forEach(p => {
            if (playerIds.includes(p.id)) {
                p.gameCount += 1;
                p.lastPlayedAt = now; // é€£ç¶šé¸å‡ºé˜²æ­¢ã®ãŸã‚æ›´æ–°
            }
        });

        // ã‚³ãƒ¼ãƒˆã‚’ç©ºã«ã™ã‚‹
        delete activeMatches[courtId];

        saveData();
        renderCourts(); // ã“ã“ã§ã‚³ãƒ¼ãƒˆã¯ã€Œç©ºãã€çŠ¶æ…‹ã«ãªã‚Šã€ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹
        updateTable();
    }

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè©¦åˆä¸­ã‹ã©ã†ã‹
    function isPlayerOnCourt(playerId) {
        for (const courtId in activeMatches) {
            const match = activeMatches[courtId];
            const allIds = [...match.teamA, ...match.teamB].map(p => p.id);
            if (allIds.includes(playerId)) return true;
        }
        return false;
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function updateTable() {
        const tbody = document.getElementById('playerListBody');
        tbody.innerHTML = '';

        // ãƒªã‚¹ãƒˆè¡¨ç¤ºé †: 
        // 1. å¾…æ©Ÿä¸­ãŒä¸Šã€è©¦åˆä¸­ãŒä¸‹
        // 2. ã‚²ãƒ¼ãƒ æ•°ãŒå°‘ãªã„é †
        // 3. å¾…æ©Ÿæ™‚é–“ãŒé•·ã„é † (lastPlayedAtãŒå°ã•ã„)
        const sorted = [...players].sort((a, b) => {
            const aBusy = isPlayerOnCourt(a.id);
            const bBusy = isPlayerOnCourt(b.id);
            if (aBusy !== bBusy) return aBusy ? 1 : -1; // å¾…æ©Ÿä¸­å„ªå…ˆ
            
            if (a.gameCount !== b.gameCount) return a.gameCount - b.gameCount;
            return a.lastPlayedAt - b.lastPlayedAt;
        });

        sorted.forEach(p => {
            const isBusy = isPlayerOnCourt(p.id);
            const statusClass = isBusy ? 'dot-playing' : 'dot-waiting';
            const statusText = isBusy ? 'è©¦åˆä¸­' : 'å¾…æ©Ÿ';
            const rowClass = isBusy ? 'background-color: #fcfcfc; color: #aaa;' : '';
            const displayGameCount = Math.round(p.gameCount * 10) / 10;
            
            // è©¦åˆä¸­ã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç„¡åŠ¹
            const checkboxDisabled = isBusy ? 'disabled' : '';

            const tr = document.createElement('tr');
            tr.style = rowClass;
            tr.innerHTML = `
                <td style="text-align: center;">
                    <input type="checkbox" class="p-select" value="${p.id}" ${checkboxDisabled} onchange="handleCheckboxChange()">
                </td>
                <td>${p.name}</td>
                <td>${p.gender}</td>
                <td>${p.level}</td>
                <td><span class="status-dot ${statusClass}"></span>${statusText}</td>
                <td>
                    <div style="display:flex; align-items:center;">
                        <button class="btn-sm" onclick="changeGameCount(${p.id}, -1)">-</button>
                        <span class="game-count-badge">${displayGameCount}</span>
                        <button class="btn-sm" onclick="changeGameCount(${p.id}, 1)">+</button>
                    </div>
                </td>
                <td><button class="btn-danger" onclick="removePlayer(${p.id})">å‰Šé™¤</button></td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('playerCount').innerText = players.length;
        handleCheckboxChange(); // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°ã®ãŸã‚
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹å¤‰æ›´æ™‚
    function handleCheckboxChange() {
        const checked = document.querySelectorAll('.p-select:checked').length;
        const btn = document.getElementById('manualMatchBtn');
        btn.innerText = `é¸æŠã—ãŸ4äººã§è©¦åˆä½œæˆ (${checked}/4)`;
        btn.disabled = (checked !== 4);
    }

    function changeGameCount(id, delta) {
        const player = players.find(p => p.id === id);
        if (player) {
            player.gameCount += delta;
            if (player.gameCount < 0) player.gameCount = 0;
            saveData();
            updateTable();
        }
    }

    function resetAllData() {
        if(confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            players = [];
            activeMatches = {};
            saveData();
            initCourts();
        }
    }

    function saveData() {
        localStorage.setItem('badmintonPlayers', JSON.stringify(players));
        localStorage.setItem('badmintonMatches', JSON.stringify(activeMatches));
    }

    function loadData() {
        const savedPlayers = localStorage.getItem('badmintonPlayers');
        const savedMatches = localStorage.getItem('badmintonMatches');
        const savedCourtCount = localStorage.getItem('badmintonCourtCount');

        if (savedPlayers) {
            players = JSON.parse(savedPlayers);
            // éå»ãƒ‡ãƒ¼ã‚¿ã«lastPlayedAtãŒãªã„å ´åˆã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
            players.forEach(p => {
                if (!p.hasOwnProperty('lastPlayedAt')) p.lastPlayedAt = 0;
            });
        }
        if (savedMatches) activeMatches = JSON.parse(savedMatches);
        if (savedCourtCount) document.getElementById('courtCount').value = savedCourtCount;
    }

</script>

</body>
</html>
